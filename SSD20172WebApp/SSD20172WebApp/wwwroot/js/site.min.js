var simulations=[],displayedSimulationsIds=[],currentSimulation={},firstSimulationExecuted=!1,currentSimulationSaved=!1,baseUrl="http://52.226.131.0/api-arena/",getSimpleSimulationPayload=function(){return{numExpertAgents:$("#numexp").val(),numNewAgents:$("#numnew").val()}},getAdvancedSimulationPayload=function(){return{numExpertAgents:$("#numexp").val(),numNewAgents:$("#numnew").val(),totalServiceDuration:$("#TAM").val(),agentLunchDuration:$("#TR").val(),minAgentsDuringLunch:$("#minage").val(),meanArrivalTime:$("#TLP").val(),lowerTransferTime:$("#TTPI").val(),upperTransferTime:$("#TTPF").val(),expertAgentMeanServiceDuration:$("#TAE").val(),newAgentMeanServiceDuration:$("#TAN").val()}},executeSimulation=function(){var n={};if($("#select-types").val()==="simple")n=getSimpleSimulationPayload();else if($("#select-types").val()==="advanced")n=getAdvancedSimulationPayload();else return;$.ajax({url:baseUrl+"run/"+$("#select-types").val(),data:n,method:"GET",beforeSend:function(){swal({title:'<img src="/images/100.GIF" />',text:"Ejecutando escenario...",allowOutsideClick:!1,showConfirmButton:!1})},success:function(n){n!==null&&n!==""&&n.status!==400?(currentSimulation=n,drawSimulationsResults(),generateAndShowFinalRecommendation(),firstSimulationExecuted=!0,currentSimulationSaved=!1,swal("Éxito","El escenario se ejecutó correctamente y ya puede ver los resultados.","success")):swal("Error","Hubo un error desconocido en la ejecución del escenario. Revise que halla completado todos los campos e inténtelo de nuevo.","error")},error:function(n){swal("Error","Hubo un error desconocido en la ejecución del escenario. Revise que halla completado todos los campos e inténtelo de nuevo.","error");console.log(n)}})},saveSimulation=function(){if(!jQuery.isEmptyObject(currentSimulation)){delete currentSimulation.simulationId;delete currentSimulation.createdOn;for(var n=0;n<currentSimulation.agent.length;n++)agent=currentSimulation.agent[n],delete agent.agentId,delete agent.simulationId,delete agent.simulation;(currentSimulation.description=$("#simulation-name").val(),currentSimulation.description!=="")&&$.ajax({url:baseUrl+"simulations/",data:JSON.stringify(currentSimulation),method:"POST",headers:{"Content-type":"application/json"},beforeSend:function(){swal({title:'<img src="/images/100.GIF" />',text:"Guardando escenario...",allowOutsideClick:!1,showConfirmButton:!1})},success:function(){$("#main-modal").modal("hide");currentSimulationSaved=!0;currentSimulation={};$("#simulation-name").val("");drawSimulationsResults();generateAndShowFinalRecommendation();swal("Éxito","Escenario guardado correctamente.","success")},error:function(n){swal("Error","El escenario no pudo guardarse debido a un error inesperado.","error");console.log(n)}})}},updateAndShowSimulations=function(){$.ajax({url:baseUrl+"simulations/",method:"GET",beforeSend:function(){swal({title:'<img src="/images/100.GIF" />',text:"Obteniendo escenarios...",allowOutsideClick:!1,showConfirmButton:!1})},success:function(n){Array.isArray(n)?(swal.close(),simulations=n,updateSimulationsModalTable(),n.length>0?showModalSimulations():swal("No hay escenarios","Actualmente no hay escenarios disponibles para mostrar.","info")):swal("Error","Los escenarios no pudieron obtenerse debido a un error inesperado.","error")},error:function(n){swal("Error","Los escenarios no pudieron obtenerse debido a un error inesperado.","error");console.log(n)}})},deleteSimulation=function(n){swal({title:"Confirmación",text:"Una vez eliminado el escenario no se podrá recuperar. ¿Seguro que desea eliminarlo?",type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Sí",cancelButtonText:"No"}).then(t=>{t.value&&$.ajax({url:baseUrl+"simulations/"+n,method:"DELETE",beforeSend:function(){swal({title:'<img src="/images/100.GIF" />',text:"Eliminando escenario...",allowOutsideClick:!1,showConfirmButton:!1})},success:function(){for(var t=0,i=!1;!i&&t<simulations.length;)simulations[t].simulationId===n?i=!0:t++;i&&(simulations.splice(t,1),$("#results-simulation-"+n).hide(),updateSimulationsModalTable(),simulations.length===0&&$("#main-modal").modal("hide"),generateAndShowFinalRecommendation());swal("Éxito","Escenario eliminado correctamente.","success")},error:function(n){swal("Error","El escenario no pudo eliminarse debido a un error inesperado.","error");console.log(n)}})})},showModalWelcome=function(){$("#header-modal-welcome").show();$("#body-modal-welcome").show();$("#footer-modal-welcome").show();$("#header-modal-manual").hide();$("#body-modal-manual").hide();$("#footer-modal-manual").hide();$("#header-modal-save").hide();$("#body-modal-save").hide();$("#footer-modal-save").hide();$("#header-modal-simulations").hide();$("#body-modal-simulations").hide();$("#footer-modal-simulations").hide();$("#main-modal").modal("show")},showModalManual=function(){$("#header-modal-welcome").hide();$("#body-modal-welcome").hide();$("#footer-modal-welcome").hide();$("#header-modal-manual").show();$("#body-modal-manual").show();$("#footer-modal-manual").show();$("#header-modal-save").hide();$("#body-modal-save").hide();$("#footer-modal-save").hide();$("#header-modal-simulations").hide();$("#body-modal-simulations").hide();$("#footer-modal-simulations").hide();$("#main-modal").modal("show")},showModalSave=function(){$("#header-modal-welcome").hide();$("#body-modal-welcome").hide();$("#footer-modal-welcome").hide();$("#header-modal-manual").hide();$("#body-modal-manual").hide();$("#footer-modal-manual").hide();$("#header-modal-save").show();$("#body-modal-save").show();$("#footer-modal-save").show();$("#header-modal-simulations").hide();$("#body-modal-simulations").hide();$("#footer-modal-simulations").hide();$("#main-modal").modal("show")},showModalSimulations=function(){$("#header-modal-welcome").hide();$("#body-modal-welcome").hide();$("#footer-modal-welcome").hide();$("#header-modal-manual").hide();$("#body-modal-manual").hide();$("#footer-modal-manual").hide();$("#header-modal-save").hide();$("#body-modal-save").hide();$("#footer-modal-save").hide();$("#header-modal-simulations").show();$("#body-modal-simulations").show();$("#footer-modal-simulations").show();$("#main-modal").modal("show")},changeSimulationType=function(){$("#select-types").val()=="simple"?$("#form-advanced").hide():$("#select-types").val()=="advanced"&&$("#form-advanced").show()};$(".only-number").keydown(function(n){$.inArray(n.keyCode,[46,8,9,27,13,110,190])!==-1||n.keyCode===65&&(n.ctrlKey===!0||n.metaKey===!0)||n.keyCode>=35&&n.keyCode<=40||(n.shiftKey||n.keyCode<48||n.keyCode>57)&&(n.keyCode<96||n.keyCode>105)&&n.preventDefault()});var attemptOpenSaveModal=function(){firstSimulationExecuted?currentSimulationSaved?swal("Escenario ya guardado","El escenario ya se encuentra guardado. Ejecute otro para volver a usar esta opción.","info"):showModalSave():swal("Escenario no ejecutado","Debe ejecutar un escenario antes de usar esta opción.","info")},drawPieChart=function(n,t){var i=new google.visualization.DataTable,r,u;i.addColumn("string","Topping");i.addColumn("number","Slices");i.addRows(n);r={title:"Utilización promedio de agentes",width:400,height:300};u=new google.visualization.PieChart(document.getElementById(t));u.draw(i,r)},drawBarChart=function(n,t,i){var r=new google.visualization.DataTable,u,f;r.addColumn("string","Topping");r.addColumn("number","Slices");r.addRows([["Atención",n*60],["En sistema",t]]);u={title:"Tiempos promedios (minutos)",width:400,height:300,legend:"none"};f=new google.visualization.BarChart(document.getElementById(i));f.draw(r,u)},drawSimulationsResults=function(){var c="",n,f,t,u,r,i,o,s,h,e;for(jQuery.isEmptyObject(currentSimulation)||(n={},n.description="Escenario actual",n.simulationId="current",n.avgNumberInQueue=currentSimulation.avgNumberInQueue,n.maxNumberInQueue=currentSimulation.maxNumberInQueue,c+=Mustache.render($("#results-row-template").html(),n)),t=0;t<displayedSimulationsIds.length;t++){for(u=!1,r=0;!u&&r<simulations.length;)displayedSimulationsIds[t]===simulations[r].simulationId?(i=JSON.parse(JSON.stringify(simulations[r])),u=!0):r++;u&&(n={},n.description=i.description,n.simulationId=i.simulationId,n.avgNumberInQueue=i.avgNumberInQueue,n.maxNumberInQueue=i.maxNumberInQueue,c+=Mustache.render($("#results-row-template").html(),n))}if($("#simulations-results").html(c),!jQuery.isEmptyObject(currentSimulation)){for(f=[],o=1,s=1,t=0;t<currentSimulation.agent.length;t++)e=currentSimulation.agent[t],e.isExpert?(f.push(["E"+o,e.utilization]),o++):(f.push(["N"+s,e.utilization]),s++);drawPieChart(f,"piechart-simulation-current");drawBarChart(currentSimulation.avgWaitingTime,currentSimulation.avgTimeInSystem,"barchart-simulation-current")}for(t=0;t<displayedSimulationsIds.length;t++){for(u=!1,r=0;!u&&r<simulations.length;)displayedSimulationsIds[t]===simulations[r].simulationId?(i=JSON.parse(JSON.stringify(simulations[r])),u=!0):r++;if(u){for(f=[],o=1,s=1,h=0;h<i.agent.length;h++)e=i.agent[h],e.isExpert?(f.push(["E"+o,e.utilization]),o++):(f.push(["N"+s,e.utilization]),s++);drawPieChart(f,"piechart-simulation-"+i.simulationId);drawBarChart(i.avgWaitingTime,i.avgTimeInSystem,"barchart-simulation-"+i.simulationId)}}generateAndShowFinalRecommendation()},undisplaySimulationResults=function(n){for(var i=!1,t=0;!i&&t<displayedSimulationsIds.length;)displayedSimulationsIds[t]===n?i=!0:t++;i&&(displayedSimulationsIds.splice(t,1),$("#results-simulation-"+n).hide())},updateDisplayedSimulationsIds=function(){displayedSimulationsIds=[];$(".button-toggle-simulation-display").each(function(){$(this).hasClass("display-simulation")&&displayedSimulationsIds.push(parseInt($(this).attr("simulationId")))});drawSimulationsResults()},generateAndShowFinalRecommendation=function(){var f=[],o,e,n,t,r,a,v,u;for($("#final-recommendation").hide(),jQuery.isEmptyObject(currentSimulation)||f.push(currentSimulation),t=0;t<displayedSimulationsIds.length;t++){for(o=!1,e=0;!o&&e<simulations.length;)displayedSimulationsIds[t]===simulations[e].simulationId?(n=JSON.parse(JSON.stringify(simulations[e])),o=!0):e++;o&&f.push(n)}if(f.length>1){var s=[],y=9999,h=[],p=9999,c=[],w=9999,l=[],b=9999,i={};for(t=0;t<f.length;t++)n=f[t],y>n.avgTimeInSystem?(y=n.avgTimeInSystem,s=[n]):y===n.avgTimeInSystem&&s.push(n),p>n.avgWaitingTime?(p=n.avgWaitingTime,h=[n]):p===n.avgWaitingTime&&h.push(n),w>n.avgNumberInQueue?(w=n.avgNumberInQueue,c=[n]):w===n.avgNumberInQueue&&c.push(n),b>n.maxNumberInQueue?(b=n.maxNumberInQueue,l=[n]):b===n.maxNumberInQueue&&l.push(n),i[n.simulationId+""]={score:0,description:n.simulationId===0?"Escenario actual":n.description,comments:[]};for(t=0;t<s.length;t++)r=i[s[t].simulationId+""],r.score++,r.comments.push({comment:"Posee el menor tiempo promedio en sistema."});for(t=0;t<h.length;t++)r=i[h[t].simulationId+""],r.score++,r.comments.push({comment:"Posee el menor tiempo promedio de atención."});for(t=0;t<c.length;t++)r=i[c[t].simulationId+""],r.score++,r.comments.push({comment:"Posee el menor promedio de clientes en cola."});for(t=0;t<l.length;t++)r=i[l[t].simulationId+""],r.score++,r.comments.push({comment:"Posee el menor máximo de clientes en cola."});a=[];v=-1;for(u in i)i.hasOwnProperty(u)&&(v<i[u].score?(v=i[u].score,a=[i[u]]):v===i[u].score&&a.push(i[u]));$("#recommended-simulations").html(Mustache.render($("#recommended-simulation-template").html(),{winners:a}));$("#final-recommendation").show()}},updateSimulationsModalTable=function(){var t,i,n;for($("#simulations-table-body").html(""),t=JSON.parse(JSON.stringify(simulations)),i="",n=0;n<t.length;n++)simulation=t[n],simulation.createdOn=simulation.createdOn.split("T")[0],i+=Mustache.render($("#simulation-row-template").html(),simulation);$("#simulations-table-body").html(i)},seeSimulationDetails=function(n){for(var f=!1,i=0,r,t,u,e,o;!f&&i<simulations.length;)simulations[i].simulationId===n?(r=simulations[i],f=!0):i++;if(f){for(t=JSON.parse(JSON.stringify(r)),t.numExpertAgents=0,t.numNewAgents=0,u=0;u<r.agent.length;u++)e=r.agent[u],e.isExpert?t.numExpertAgents+=1:t.numNewAgents+=1;o=Mustache.render($("#simulation-details-template").html(),t);$("#simulation-details-table-body").html(o);$("#secondary-modal").modal("show")}},main=function(){showModalWelcome()};$(document).ready(main);